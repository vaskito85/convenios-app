--- # üí≥ Asistente de Convenios de Pago Aplicaci√≥n Streamlit para gestionar convenios de pago con soporte de: - Usuarios y roles (admin, operador, cliente) - Creaci√≥n y env√≠o de convenios a clientes para aceptaci√≥n - C√°lculo de cuotas (Sistema Franc√©s y Capital Fijo / Inter√©s sobre saldo) - Gesti√≥n de comprobantes (upload al Storage, aprobaci√≥n/rechazo) - M√©tricas y tableros (admin/operador) - Recordatorios autom√°ticos de cuotas pr√≥ximas o vencidas (worker + GitHub Actions) Backend de datos y archivos sobre Firebase (Firestore + Storage) y Firebase Auth. --- ## üß≠ √çndice - #arquitectura - #roles-y-permisos - #modelo-de-datos - #estados-del-convenio-y-ciclo-de-vida - #c√°lculo-de-cuotas - #emails-y-notificaciones - #recordatorios-autom√°ticos - #estructura-del-repo - #configuraci√≥n-secretsvariables - #instalaci√≥n-y-ejecuci√≥n-local - #despliegue--ci - #seguridad-y-buenas-pr√°cticas - #soluci√≥n-de-problemas - #roadmap--mejoras-sugeridas - #licencia --- ## Arquitectura - Frontend/Server: https://streamlit.io - Autenticaci√≥n: Firebase Authentication - Alta/gesti√≥n de usuarios con Firebase Admin SDK - Login por REST (accounts:signInWithPassword) - Base de datos: Cloud Firestore (Admin SDK) - Almacenamiento: Firebase Storage (Admin SDK) ‚Äì comprobantes PDF/JPG/PNG - Email: SMTP est√°ndar (configurable), plantillas HTML simples - Worker de recordatorios: script Python ejecutado por GitHub Actions en CRON --- ## Roles y permisos - Admin - Panel de m√©tricas globales - Aprobaci√≥n/rechazo de nuevos usuarios - Eliminaci√≥n de convenios - Diagn√≥stico (secrets, warmup, ping Firestore) - Disparar manualmente recordatorios (opcional) - Operador - Crear convenios, recalcular calendario - Enviar a aceptaci√≥n - Revisar comprobantes (aprobar/rechazar; marca pagada) - Panel de m√©tricas personales - Cliente - Aceptar/rechazar convenio - Subir comprobantes por cuota - Ver su calendario y estado --- ## Modelo de datos users (colecci√≥n) {uid}: { email, full_name, role ‚àà {admin, operador, cliente}, status ‚àà {PENDING, APPROVED, REJECTED}, rejection_note? : string } agreements (colecci√≥n) {agreementId}: { title, notes, operator_id (uid), client_id? (uid), client_email (fallback), principal (float), interest_rate (float mensual), installments (int), method ‚àà {"french", "declining"}, status ‚àà {DRAFT, PENDING_ACCEPTANCE, ACTIVE, COMPLETED, CANCELLED, REJECTED}, start_date (YYYY-MM-DD), created_at, accepted_at?, completed_at? } agreements/{agreementId}/installments (subcolecci√≥n) {installmentId}: { number (1..n), due_date (YYYY-MM-DD), capital (float), interest (float), total (float), paid (bool), paid_at?, last_reminder_sent?, receipt_status? ‚àà {PENDING, APPROVED, REJECTED}, receipt_url?, receipt_note?, receipt_uploaded_by?, receipt_uploaded_at? } > Nota: se guarda client_email en el convenio como fallback (sirve si el cliente a√∫n no tiene uid). --- ## Estados del convenio y ciclo de vida 1. DRAFT: creado por el operador; puede recalcularse el calendario. 2. PENDING_ACCEPTANCE: enviado al cliente; el cliente acepta o rechaza. 3. ACTIVE: aceptado por el cliente; se gestionan pagos y comprobantes. 4. COMPLETED: todas las cuotas pagadas ‚Üí marcado autom√°tico. 5. CANCELLED: cancelado por admin/operador (solo si estaba en DRAFT/PENDING). 6. REJECTED: rechazado por el cliente (guarda rejection_note). --- ## C√°lculo de cuotas Dos m√©todos soportados en calculations.py: - Sistema Franc√©s (cuota fija) La √∫ltima cuota ajusta capital (y total) para neutralizar residuos de redondeo. - Capital Fijo (inter√©s sobre saldo / declining) Capital constante; la √∫ltima cuota ajusta por redondeos. Ambos m√©todos generan cuotas con: number, due_date, capital, interest, total. --- ## Emails y notificaciones - Registro de usuario: recibido, aprobado, rechazado - Convenios: enviado a aceptaci√≥n, aceptado, rechazado - Comprobantes: nuevo (al operador), aprobado/rechazado (al cliente) - Remitente/SMTP: configurable por secrets/env (SMTP_*) > Plantillas HTML simples en emailer.py (f√°ciles de personalizar). --- ## Recordatorios autom√°ticos Archivo: send_reminders.py (worker) - Recorre convenios ACTIVE y busca cuotas impagas: - Pr√≥ximas a vencer (‚â§ REMINDER_DAYS_BEFORE) - Hoy - Vencidas (‚â§ REMINDER_DAYS_AFTER) - Respeta last_reminder_sent y un cooldown (REMINDER_COOLDOWN_DAYS) para no spamear. - Resuelve email del cliente por client_id (si existe) o client_email del convenio. - Env√≠a el recordatorio (opcional: copia al operador) y actualiza last_reminder_sent. ### GitHub Actions (CRON) Workflow: .github/workflows/reminders.yml Se ejecuta diario a las 12:00 UTC (~09:00 Buenos Aires), con disparo manual (workflow_dispatch) disponible. Variables utilizadas (secrets): - FIREBASE_CREDENTIALS (JSON de Service Account, pegado tal cual) - FIREBASE_PROJECT_ID - SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_USE_TLS, SMTP_SENDER - APP_BASE_URL - (Opcionales del worker) APP_TZ, REMINDER_DAYS_BEFORE, REMINDER_DAYS_AFTER, REMINDER_COOLDOWN_DAYS --- ## Estructura del repo . ‚îú‚îÄ app.py # App principal (Streamlit) ‚îú‚îÄ auth.py # Registro/login, roles, gesti√≥n de usuarios ‚îú‚îÄ calculations.py # C√°lculo de cuotas (franc√©s/declining) ‚îú‚îÄ emailer.py # Env√≠o de correos + plantillas ‚îú‚îÄ firebase_init.py # Inicializaci√≥n Admin SDK (credenciales/bucket) ‚îú‚îÄ send_reminders.py # Worker de recordatorios (CLI/Streamlit opcional) ‚îú‚îÄ requirements.txt # Dependencias ‚îî‚îÄ .github/ ‚îî‚îÄ workflows/ ‚îî‚îÄ reminders.yml # CRON de recordatorios (GitHub Actions) --- ## Configuraci√≥n (secrets/variables) ### 1) Streamlit (.streamlit/secrets.toml) ‚Äî para app.py toml # .streamlit/secrets.toml FIREBASE_CREDENTIALS = """ { ... JSON del Service Account ... } """ FIREBASE_PROJECT_ID = "tu-proyecto" FIREBASE_STORAGE_BUCKET = "tu-proyecto.appspot.com" # opcional FIREBASE_WEB_API_KEY = "xxx..." # para login REST APP_BASE_URL = "https://tu-dominio-o-streamlit.app" SMTP_HOST = "smtp.tu-dominio.com" SMTP_PORT = "587" SMTP_USER = "no-reply@tu-dominio.com" SMTP_PASS = "********" SMTP_USE_TLS = "true" SMTP_SENDER = "Asistente de Convenios <no-reply@tu-dominio.com>" ADMIN_EMAILS = "admin1@dominio.com, admin2@dominio.com" # opcional  > Nota: FIREBASE_CREDENTIALS es el contenido del JSON (triple comillas), no una ruta a archivo. ### 2) Variables de entorno ‚Äî para worker en GitHub Actions o cron - Obligatorias: FIREBASE_CREDENTIALS, FIREBASE_PROJECT_ID, SMTP_*, APP_BASE_URL - Opcionales: APP_TZ (por defecto America/Argentina/Buenos_Aires), REMINDER_* --- ## Instalaci√≥n y ejecuci√≥n local bash # 1) Crear y activar venv python -m venv .venv source .venv/bin/activate # (Windows: .venv\Scripts\activate) # 2) Instalar deps pip install --upgrade pip pip install -r requirements.txt # 3) Configurar secrets de Streamlit # Crear .streamlit/secrets.toml (ver ejemplo arriba) # 4) Ejecutar la app streamlit run app.py  ### Probar el worker de recordatorios (local) bash # con las variables de entorno seteadas: export FIREBASE_CREDENTIALS='{"type":"service_account", ...}' export FIREBASE_PROJECT_ID='tu-proyecto' export SMTP_HOST='...' # ... otros SMTP_* y APP_BASE_URL ... python send_reminders.py  > Opcional: tambi√©n pod√©s correr streamlit run send_reminders.py y ejecutar el job con un bot√≥n (solo admin). --- ## Despliegue / CI - GitHub Actions: reminders.yml ejecuta el worker diario (12:00 UTC) y permite disparo manual. - Despliegue de la app: - Streamlit Community/Cloud, o - Contenedor/VM con streamlit run app.py. - Firebase Emuladores (opcional para local): soportado v√≠a variables FIRESTORE_EMULATOR_HOST / STORAGE_EMULATOR_HOST si los us√°s. - ADC (Application Default Credentials): firebase_init.py intenta ADC si no encuentra FIREBASE_CREDENTIALS (√∫til en Cloud Run/Functions o local con GOOGLE_APPLICATION_CREDENTIALS). --- ## Seguridad y buenas pr√°cticas - Service Account: guardalo en secrets (nunca lo comitees). - SMTP: us√° TLS/SSL y una cuenta exclusiva para la app. - URLs firmadas de Storage para comprobantes (expiran a los 15 minutos). - Roles: la UI muestra p√°ginas seg√∫n role y status; el seed admin fuerza a crear un admin si no hay usuarios. - Cierre autom√°tico: si todas las cuotas est√°n pagadas, el convenio pasa a COMPLETED. --- ## Soluci√≥n de problemas - ‚ÄúNo se pudo conectar a Firestore (warmup)‚Äù: verific√° FIREBASE_CREDENTIALS y FIREBASE_PROJECT_ID en secrets/entorno. - Email no llega: revis√° SMTP_* y autenticaci√≥n; cheque√° SPAM, DKIM/SPF/DMARC. - Cliente no aparece en ‚ÄúMis convenios‚Äù: si el convenio fue creado con solo client_email, el filtro debe considerar email (ya est√° resuelto en app.py). - Recordatorios no salen: corr√© send_reminders.py local o workflow_dispatch en Actions; revis√° logs de ejecuci√≥n. --- ## Roadmap / mejoras sugeridas - Paginaci√≥n y filtros en listados grandes (operador/admin). - Adjuntar comprobante al email (o link firmado con expiraci√≥n custom) al aprobar/rechazar. - Exportar calendario (CSV/Excel/PDF) y env√≠o al cliente. - Dashboards con gr√°ficos (aceptaci√≥n, mora, recaudaci√≥n). - Soporte de storage alternativo (R2/S3) guardando solo la URL p√∫blica/firmada. - Reset de contrase√±a por link (Gmail API / Identity Toolkit) como alternativa al reset temporal. --- ## Licencia Este proyecto se publica bajo GPL-3.0 (ver archivo LICENSE en el repo). --- ## Cr√©ditos - Desarrollo y mantenimiento: Germ√°n Berterreix - Colaboraci√≥n y soporte t√©cnico: asistentes y contribuyentes del repo --- ### ¬øNecesit√°s ayuda? Abr√≠ un issue o ejecut√° workflow_dispatch en Actions para probar recordatorios.
